<!DOCTYPE html>

<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>Pele</title> 
<script src="http://maps.google.com/maps?file=api&amp;v=3&amp;key=ABQIAAAAZayeFes7LfpQuCEpjgcrnxQoDgDKWEm0nXgjAhQghs-QBZx6WxSMe_HIlvS_PrEM0Zl20DKHP6-Csg" type="text/javascript"></script> 
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 
 
  
<script type="text/javascript"> 
    //luodaan muuttujat
    var kapsi//var openlayersWMS;
    
    //Jos muuttujia ei ole annettu osoiterivillä, käytetään näitä
      var lat = 60.170833;
      var lng = 24.9375;
      var zoom = 4;
      var maptype = google.maps.MapTypeId.SATELLITE;
      var map = null; 
 
    function initialize() {
    	

      // ========== Read paramaters that have been passed in ==========
      
	//Luetaan osoiteriville annetut parametrit
	//Etsitään parametrejä muodossa "?lat=50&lng=-3"

      // Hypätään yli ensimmäisestä osoitteesta ja etsitään "?" jälkeen tulevat
      var query = location.search.substring(1);

      // Katkaistaa aina "&" kohdalla ja laitetaan kirjaimet listalle "argname=value"
      var pairs = query.split("&");
      for (var i=0; i<pairs.length; i++) {
        // Katkaistaan aina "=" kohdalta jolloin annetaan ensimmäiseksi osaksi "argname" ja toiseksi arvo
	var pos = pairs[i].indexOf("=");
	var argname = pairs[i].substring(0,pos).toLowerCase();
	var value = pairs[i].substring(pos+1).toLowerCase();
        // etsitään listalta koordinaatteja
        if (argname == "lat") {lat = parseFloat(value);}
        if (argname == "lng") {lng = parseFloat(value);}
      }
      
        // Asetetaan kartalle ominaisuudet
        var map_setup = {
            zoom: zoom,
            mapTypeId: google.maps.MapTypeId.SATELLITE,
            MapTypeControl: true,
            mapTypeControlOptions: { style: google.maps.MapTypeControlStyle.DROPDOWN_MENU },
            navigationControl: true,
            navigationControlOptions: { style: google.maps.NavigationControlStyle.ZOOM_PAN },
            backgroundColor: 'White',
            scrollwheel: true,
            maxZoom: 30,
            minZoom: 13,
            scaleControl: true,
            center: new google.maps.LatLng(lat,lng)//map_center
        }
 
        map = new google.maps.Map(document.getElementById("map"), map_setup);
      
 	// Tehdään WMS-layerille ominaisuudet. Kutsuu WMSGetTileUrl osoitteen muodostamiseksi
        var wmsOptions = {
            alt: "kapsi",
            getTileUrl: WMSGetTileUrl,//peruslurl,
            isPng: false,
            maxZoom: 30,
            minZoom: 1,
            name: "kapsi",
            tileSize: new google.maps.Size(256, 256)

        };

        
 
        // Luodaan objektin tyypiksi ImageMapType ja ominaisuuksiksi wmsOptionsit

        kapsiWMS = new google.maps.ImageMapType(wmsOptions);
        
      
        // Laitetaan layeri kartalle. Ensimmäinen "string" antaa layerille nimen tiputusvalikkoon ja toinen kutsuu sitä

        map.mapTypes.set('kapsi', kapsiWMS);
        
       
 
        // Asetukset kartalle vielä lisäksi. 
        map.setOptions({
            mapTypeControlOptions: {
                mapTypeIds: [
		  'kapsi',
		 
		   google.maps.MapTypeId.SATELLITE
		],
                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
            }
        });
 
    //Asetetaan ensimmäiseksi karttatyypiksi Kapsi
    map.setMapTypeId('kapsi');
    
    AddWMSLayer();

}
 
 //WMS layerin urlin hakeminen
 
  function WMSGetTileUrl(tile, zoom) {
      var projection = window.map.getProjection();
      var zpow = Math.pow(2, zoom);
      var ul = new google.maps.Point(tile.x * 256.0 / zpow, (tile.y + 1) * 256.0 / zpow);
      var lr = new google.maps.Point((tile.x + 1) * 256.0 / zpow, (tile.y) * 256.0 / zpow);
      var ulw = projection.fromPointToLatLng(ul);
      var lrw = projection.fromPointToLatLng(lr);
      //perus urlin hakeminen
      var baseURL = "http://tiles.kartat.kapsi.fi/ortokuva?"
      var version = "1.3.0";
      var request = "GetMap";
      var format = "PNG"//"image%2Fjpeg"; //type of image returned  or image/jpeg
      //The layer ID.  Can be found when using the layers properties tool in ArcMap or from the WMS settings 
      //var layers = "Foundation.GTOPO30";
      //projection to display. This is the projection of google map. Don't change unless you know what you are doing.  
      //Different from other WMS servers that the projection information is called by crs, instead of srs
      var crs = "EPSG:4326"; 
      //With the 1.3.0 version the coordinates are read in LatLon, as opposed to LonLat in previous versions
      var bbox = ulw.lat() + "," + ulw.lng() + "," + lrw.lat() + "," + lrw.lng();
      var service = "WMS";
      //the size of the tile, must be 256x256
      var width = "256";
      var height = "256";
      var styles = "default";
      var url = baseURL + "Service=" + service + "&request=" + request + "&version=" + version + "&Styles=" + styles + "&format=" + format + "&width=" + width + "&height=" + height + "&CRS=" + crs + "&BBOX=" + bbox
      return url;
  }

    function AddWMSLayer()
        {
        	/*
                 //Define custom WMS tiled layer
                perusLayer = new google.maps.ImageMapType({
                getTileUrl: peruslurl,               
                //tileSize: new google.maps.Size(256, 256),
                //opacity: 0.5, // setting image TRANSPARENCY 
                isPng: false
            });  
    
    
    
    
    map.overlayMapTypes.push(perusLayer);
    */
            var peruslOptions = {
            alt: "perusLayer",
            getTileUrl: peruslurl,
            isPng: false,
            maxZoom: 30,
            minZoom: 1,
            name: "perusLayer",
            //tileSize: new google.maps.Size(256, 256)
        };
 
 
        //Creating the object to create the ImageMapType that will call the WMS Layer Options. 
        
       perusLayer = new google.maps.ImageMapType(peruslOptions);
 
      
    //Where the initial map type is set.  This can be adjusted as necessary.  The map name in ' ' indicates the default map viewed when the user 
    //visits the page


    map.overlayMapTypes.insertAt(0, perusLayer);


    
    
    
        }


 //WMS layerin urlin hakeminen vuoden 2014 peruslohkoille
 
  function peruslurl(tile, zoom) {
      var projection = window.map.getProjection();
      var zpow = Math.pow(2, zoom);
      var ul = new google.maps.Point(tile.x * 256.0 / zpow, (tile.y + 1) * 256.0 / zpow);
      var lr = new google.maps.Point((tile.x + 1) * 256.0 / zpow, (tile.y) * 256.0 / zpow);
      var ulw = projection.fromPointToLatLng(ul);
      var lrw = projection.fromPointToLatLng(lr);
      //perus urlin hakeminen
      var baseURL = "https://karttakuva-testi.mmmtike.fi/cgi-bin/maviwms1?"
      var version = "1.3.0";
      var request = "GetMap";
      var format = "image%2Fjpeg"; //type of image returned  or image/jpeg
      //The layer ID.  Can be found when using the layers properties tool in ArcMap or from the WMS settings 
      //var layers = "Foundation.GTOPO30";
      //projection to display. This is the projection of google map. Don't change unless you know what you are doing.  
      //Different from other WMS servers that the projection information is called by crs, instead of srs
      var crs = "EPSG:4326"; 
      //With the 1.3.0 version the coordinates are read in LatLon, as opposed to LonLat in previous versions
      var bbox = ulw.lat() + "," + ulw.lng() + "," + lrw.lat() + "," + lrw.lng();
      var service = "WMS";
      //the size of the tile, must be 256x256
      var width = "256";
      var height = "256";
      var layers = "pl_2015"
      var styles = "default";
      var url = baseURL + "Service=" + service + "&request=" + request + "&version=" + version + "&Styles=" + styles + "&format=" + format 
      url += "&width=" + width + "&height=" + height + "&TRANSPARENT=TRUE"
      url += "&LAYERS=" + layers + "&CRS=" + crs + "&BBOX=" + bbox
      return url;
  }
  
  function RemoveLayer() {
            if(perusLayer)
            {          
                map.overlayMapTypes.removeAt(0);           
            }
        }
  
 
</script> 
 
</head> 
<body style="margin:0px; padding:0px; font-family:Arial" onload="initialize()"> 
<a href="#" onclick="AddWMSLayer();">Näytä peltolohkorajat</a> &nbsp;&nbsp;
<a href="#" onclick="RemoveLayer();">Poista peltolohkorajat</a> <br /><br />
<div id="map" style="position:absolute; left:10px; width:1000px; height:700px;"></div> 
 
 
</body> 
</html> 
