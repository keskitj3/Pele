<!DOCTYPE html>

<html> 
<head> 
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
<title>Pele</title> 
<script src="http://maps.google.com/maps?file=api&amp;v=3&amp;key=ABQIAAAAZayeFes7LfpQuCEpjgcrnxQoDgDKWEm0nXgjAhQghs-QBZx6WxSMe_HIlvS_PrEM0Zl20DKHP6-Csg" type="text/javascript"></script> 
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script> 

<style>
h1 {
    letter-spacing: 1px;
font: 10px arial;
display: inline;
position: absolute;
bottom: 0;
}
h2{
	letter-spacing: 2px;
font: 20px arial;
}
#map {
	width:100%; 
	height:90%; 
	position:absolute; 
}
</style>
  
<script type="text/javascript"> 
    //luodaan muuttujat
    var kapsi
    
    //Jos muuttujia ei ole annettu osoiterivillä, käytetään näitä
      var lat = 60.170833;
      var lng = 24.9375;
      var zoom = 17;
      var maptype = google.maps.MapTypeId.SATELLITE;
      var map = null; 

	//Luetaan osoiteriville annetut parametrit
	//Etsitään parametrejä muodossa "?lat=50&lng=-3"

      // Hypätään yli ensimmäisestä osoitteesta ja etsitään "?" jälkeen tulevat
      var query = location.search.substring(1);

      // Katkaistaan aina "&" kohdalla ja laitetaan kirjaimet listalle "argname=value"
      var pairs = query.split("&");
      for (var i=0; i<pairs.length; i++) {
        // Katkaistaan aina "=" kohdalta jolloin annetaan ensimmäiseksi osaksi "argname" ja toiseksi arvo
	var pos = pairs[i].indexOf("=");
	var argname = pairs[i].substring(0,pos).toLowerCase();
	var value = pairs[i].substring(pos+1).toLowerCase();
        // etsitään listalta koordinaatteja
        if (argname == "lat") {lat = parseFloat(value);}
        if (argname == "lng") {lng = parseFloat(value);}
      }
 
    function initialize() {
    	
       // Asetetaan kartalle ominaisuudet
        var map_setup = {
            zoom: zoom,
            mapTypeId: google.maps.MapTypeId.SATELLITE,
            MapTypeControl: true,
            mapTypeControlOptions: { style: google.maps.MapTypeControlStyle.DROPDOWN_MENU },
            navigationControl: true,
            navigationControlOptions: { style: google.maps.NavigationControlStyle.ZOOM_PAN },
            backgroundColor: 'White',
            scrollwheel: true,
            maxZoom: 30,
            minZoom: 5,
            scaleControl: true,
            center: new google.maps.LatLng(lat,lng)
        }
 
        map = new google.maps.Map(document.getElementById("map"), map_setup);
      
 	// Tehdään WMS-layerille ominaisuudet. Kutsuu WMSGetTileUrl osoitteen muodostamiseksi
        var wmsOptions = {
            alt: "kapsi",
            getTileUrl: WMSGetTileUrl,//peruslurl,
            isPng: false,
            maxZoom: 30,
            minZoom: 1,
            name: "kapsi",
            tileSize: new google.maps.Size(256, 256)

        };

        // Luodaan objektin tyypiksi ImageMapType ja ominaisuuksiksi wmsOptionsit

        kapsiWMS = new google.maps.ImageMapType(wmsOptions);
     
        // Laitetaan layeri kartalle. Ensimmäinen "string" antaa layerille nimen tiputusvalikkoon ja toinen kutsuu sitä

        map.mapTypes.set('kapsi', kapsiWMS);
        
       // Asetukset kartalle vielä lisäksi. 
        map.setOptions({
            mapTypeControlOptions: {
                mapTypeIds: [
		  'kapsi',
		 
		   google.maps.MapTypeId.SATELLITE
		],
                style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
            }
        });
 
    //Asetetaan ensimmäiseksi karttatyypiksi Kapsi
    map.setMapTypeId('kapsi');
    
    AddWMSLayer();

}
 
 //WMS layerin urlin hakeminen
 
  function WMSGetTileUrl(tile, zoom) {
      var projection = window.map.getProjection();
      var zpow = Math.pow(2, zoom);
      var ul = new google.maps.Point(tile.x * 256.0 / zpow, (tile.y + 1) * 256.0 / zpow);
      var lr = new google.maps.Point((tile.x + 1) * 256.0 / zpow, (tile.y) * 256.0 / zpow);
      var ulw = projection.fromPointToLatLng(ul);
      var lrw = projection.fromPointToLatLng(lr);
      //perus urlin hakeminen
      var baseURL = "http://tiles.kartat.kapsi.fi/ortokuva?"
      var version = "1.3.0";
      var request = "GetMap";
      //palauttaa kuvan joko image tai jpeg
      var format = "image%2Fjpeg";
      //koordinaatit
      var crs = "EPSG:4326"; 
      //näytettävän alueen ulkorajat
      var bbox = ulw.lat() + "," + ulw.lng() + "," + lrw.lat() + "," + lrw.lng();
      var service = "WMS";
      //tile koon tulee olla 256x256
      var width = "256";
      var height = "256";
      var styles = "default";
      var url = baseURL + "Service=" + service + "&request=" + request + "&version=" + version + "&Styles=" + styles + "&format=" + format + "&width=" + width + "&height=" + height + "&CRS=" + crs + "&BBOX=" + bbox
      return url;
  }

    function AddWMSLayer()
        {

            var peruslOptions = {
            alt: "perusLayer",
            getTileUrl: peruslurl,
            isPng: false,
            maxZoom: 30,
            minZoom: 1,
            name: "perusLayer",

        };
   
       perusLayer = new google.maps.ImageMapType(peruslOptions);
 
    map.overlayMapTypes.clear();
    map.overlayMapTypes.insertAt(0, perusLayer);
        }


 //WMS layerin urlin hakeminen vuoden 2014 peruslohkoille
 
  function peruslurl(tile, zoom) {
      var projection = window.map.getProjection();
      var zpow = Math.pow(2, zoom);
      var ul = new google.maps.Point(tile.x * 256.0 / zpow, (tile.y + 1) * 256.0 / zpow);
      var lr = new google.maps.Point((tile.x + 1) * 256.0 / zpow, (tile.y) * 256.0 / zpow);
      var ulw = projection.fromPointToLatLng(ul);
      var lrw = projection.fromPointToLatLng(lr);
      //perus urlin hakeminen
      var baseURL = "https://karttakuva-testi.mmmtike.fi/cgi-bin/maviwms1?"
      var version = "1.3.0";
      var request = "GetMap";
      var format = "image%2Fpng"; 
      var crs = "EPSG:4326"; 
      var bbox = ulw.lat() + "," + ulw.lng() + "," + lrw.lat() + "," + lrw.lng();
      var service = "WMS";
      var width = "256";
      var height = "256";
      var layers = "pl_2015"
      var styles = "default";
      var url = baseURL + "Service=" + service + "&request=" + request + "&version=" + version + "&Styles=" + styles + "&format=" + format 
      url += "&width=" + width + "&height=" + height + "&TRANSPARENT=TRUE"
      url += "&LAYERS=" + layers + "&CRS=" + crs + "&BBOX=" + bbox
      return url;
  }
  
  function RemoveLayer() {
        map.overlayMapTypes.clear();
        }
  
 
</script> 
 
</head> 
<body style="margin:0px; padding:0px; font-family:Arial" onload="initialize()"> 
<h2><a href="#" onclick="AddWMSLayer();">Näytä peltolohkorajat</a> &nbsp;&nbsp;
<a href="#" onclick="RemoveLayer();">Poista peltolohkorajat</a> </h2>
<div id="map"></div> 
<h1>
	Käytetty aineisto:<p class="lead">Maanmittauslaitoksen ortokuva-aineisto (
	<a target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.fi">lisenssi</a>) 
	<a target="_blank" href="http://kartat.kapsi.fi/">Kapsi Internet-käyttäjät ry:n</a> tarjoamana
	ja Maaseutuviraston peltolohkorekisteriä (<a target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.fi">lisenssi</a>)
	<!--<p class="lead"><a target="_blank" href="http://kartat.kapsi.fi/">Kapsi Internet-käyttäjät ry:n</a> tarjoamana</p> -->
	<!--p class="lead">Maaseutuviraston peltolohkorekisteriä (<a target="_blank" href="https://creativecommons.org/licenses/by/4.0/deed.fi">lisenssi</a>)</p> -->
</h1> 


</body> 
</html> 
